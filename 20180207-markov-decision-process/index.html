<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style" />
    <meta content="telephone=no" name="format-detection" />
    <title>
Markov Decision Process | 叶某人的碎碎念    </title>
    <link rel="stylesheet" type="text/css" href="/theme/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/theme/css/pygment.css" />
    <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/normalize/6.0.0/normalize.min.css" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/pure-min.css" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico" />
</head>

<body>
<div class="body_container">
    <div id="header">
        <div class="site-name">
            <a id="logo" href="/."> 叶某人的碎碎念 </a>
            <p class="description"> Believe in Mathematics </p>
        </div>
        <div id="nav-menu">
            <a href="/."><i class="fa fa-home"> Home</i></a>
            <a href="/movies/"><i class="fa fa-film"> Movies</i></a>
            <a href="/archives.html"><i class="fa fa-archive"> Archive</i></a>
        </div>
    </div>
    <div id="layout" class="pure-g">
        <div class="pure-u-1 pure-u-lg-3-4"><div class="content_container">
<div class="post">
    <h1 class="post-title">Markov Decision Process</h1>
    <div class="post-meta">Feb 07, 2018
    <span> | </span> <span>Machine Learning</span>
    </div>
    <a data-disqus-identifier="20180207-markov-decision-process/" href="/20180207-markov-decision-process/#disqus_thread" class="disqus-comment-count"></a>
    <div class="post-content">
        <p>This article is my notes for 16th lecture in <a href="https://www.youtube.com/playlist?list=PLA89DCFA6ADACE599">Machine Learning</a> by Andrew Ng on Markov Decision Process (MDP). MDP is a typical way in machine learning to formulate <a href="https://en.wikipedia.org/wiki/Reinforcement_learning">reinforcement learning</a>, whose tasks roughly speaking are to train agents to take actions in order to get maximal rewards in some settings. One example of reinforcement learning would be developing a game bot to play <a href="https://en.wikipedia.org/wiki/Super_Mario">Super Mario</a> on its own. </p>
<p>Another simple example is used in the lecture, and I will use it throughout the post as well. Since the example is really simple, so MDP shown below is not of the most general form, but only good enough to solve the example and give the idea of what MDP and reinforcement learning are. The example begins with a 3 by 4 grid as below.</p>
<p><img alt="the grid" src="/images/20180207-example-1.png"></p>
<!--more-->

<p>The number in each cell represents the immediate reward when a robot enters it, with discount factor <span class="math">\(\gamma = 0.99\)</span> which will be explained later. The shaded cell represents a place where the robot can not enter. The robot can move in four directions: right, left, up and down. Due to some defects, the robot can only go in the direction it intends with 0.8 probability, and with 0.1 each going into the adjacent directions. For example, if a robot decides to move upward, it will only happen in probability 0.8, and there will be 10% chances going right and 10% chances going left. Moreover, if a robot move in a direction which leads it to leave the grid or into the shaded cell, then it will stay. Finally, we assume that if a robot reaches the cells with +1 or -1, it stops.</p>
<p>Given all these constraints, we want to train a robot, when put at a cell with reward -0.02, to take the best route to the cell with reward 1 and avoid the cell with reward -1.</p>
<p>This is an easy reinforcement learning task, which we will learn how to solve later. Before that, we need to formulate reinforcement learning using MDP, so that we can solve it.</p>
<div class="qbar">
<p>Markov Decision Process (MDP) consists of fives components:</p>
<ol>
<li>a set of states <span class="math">\(S\)</span>;</li>
<li>a set of actions <span class="math">\(A\)</span>;</li>
<li>state transition distributions <span class="math">\(P_{sa}\)</span> for each <span class="math">\(s \in S\)</span> and <span class="math">\(a \in A\)</span>, where <span class="math">\(P_{sa}(s^\prime)\)</span> is the probability of changing from state <span class="math">\(s\)</span> to state <span class="math">\(s^\prime\)</span> when taking action <span class="math">\(a\)</span>;</li>
<li>discount factor <span class="math">\(\gamma \in [0, 1)\)</span>;</li>
<li>reward function <span class="math">\(R: S \to \R\)</span>.</li>
</ol>
</div>
<p>In our example, states can be parametrized by a pair <span class="math">\((i, j)\)</span> indicating the cell at row <span class="math">\(i\)</span> and column <span class="math">\(j\)</span>. Thus, we have a set of states<br>
</p>
<div class="math">$$S = \{(0, 0), (0, 1), (0, 2), (0, 3), (1, 0), (1, 2), (1, 3), (2, 0), (2, 1), (2, 2), (2, 3)\}.$$</div>
<p><br>
The set of actions <span class="math">\(A\)</span> contains four elements: up(U), down(D), right(R) and left(L), so<br>
</p>
<div class="math">$$A = \{U, D, R, L\}.$$</div>
<p>We have 11 states and 4 actions, so there are in total 44 state transition distributions. I would only write down two distributions explicitly. The first distribution we want like to look at is taking right at state (1, 2):<br>
</p>
<div class="math">\begin{equation*}
P_{(1, 2), R}(s) = \left\{\begin{array}{ll}
0.8, &amp; \text{ if } s = (1, 3) \\
0.1, &amp; \text{ if } s = (0, 2) \text{ or } (2, 2) \\
0, &amp; \text{ otherwise}
\end{array}\right.
\end{equation*}</div>
<p><br>
The next distribution is to move downward at state <span class="math">\((2, 2)\)</span>:<br>
</p>
<div class="math">\begin{equation*}
P_{(2, 2), D}(s) = \left\{\begin{array}{ll}
0.8, &amp; \text{ if } s = (2, 2) \\
0.1, &amp; \text{ if } s = (2, 1) \text{ or } (2, 3) \\
0, &amp; \text{ otherwise}
\end{array}\right.
\end{equation*}</div>
<p>The reward function <span class="math">\(R\)</span> has been already indicated in the figure above. To be more precise, it is<br>
</p>
<div class="math">\begin{equation*}
R(s) = \left\{\begin{array}{ll}
1, &amp; \text{ if } s = (0, 3) \\
-1, &amp; \text{ if } s = (1, 3) \\
-0.02, &amp; \text{ otherwise}
\end{array}\right.
\end{equation*}</div>
<p>Finally, the discount factor <span class="math">\(\gamma\)</span> is 0.99, which is used in the calculation of <em>payoff</em>. Suppose we have a series of actions applied to initial state <span class="math">\(s_0\)</span>, and get the following sequence of states:<br>
</p>
<div class="math">$$s_0 \xrightarrow{a_1} s_1 \xrightarrow{a_2} s_2 \to \cdots$$</div>
<p><br>
The <em>expected payoff</em> of this series of actions at initial state <span class="math">\(s_0\)</span> is defined to be<br>
</p>
<div class="math">$$R(s_0) + \sum_{t=1}^{\infty} \gamma^t E_{s_t \sim a_t}R(s_t) = R(s_0) + \gamma E_{s_1 \sim a_1}R(s_1) + \gamma^2 E_{s_2 \sim a_2}R(s_2) + \cdots.$$</div>
<p>The goal of reinforcement learning is to choose action for every state so that the expected payoff is maximized.</p>
<div class="qbar">
<p><strong>Definitions.</strong> A <em>policy</em> <span class="math">\(\pi\)</span> is a map <span class="math">\(\pi: S \to A\)</span>. A policy <span class="math">\(\pi\)</span> is <em>executed</em> if for state <span class="math">\(s\)</span>, action <span class="math">\(\pi(s)\)</span> is taken. Finally, the <em>value function</em> for a policy <span class="math">\(\pi\)</span> is given by<br>
<div class="math">$$V^\pi(s) = E[R(s_0) + \gamma R(s_1) + \gamma^2 R(s_2) + \cdots| s_0 = s, \pi].$$</div>
</p>
</div>
<p>Let's look at a policy <span class="math">\(\pi\)</span> for our example:<br>
<img alt="policy" src="/images/20180207-example-2.png"><br>
The arrows in the figure represent the actions to take. Note that, states (0, 3) and (1, 3) have no actions since they are places to stop. Now comes a question: How can we calculate <span class="math">\(V^\pi\)</span>? To this end, we need to observe that<br>
</p>
<div class="math">$$V^\pi(s) = R(s) + \gamma\sum_{s_1 \in S}P_{s, \pi(s)}(s_1)E[R(s_1) + \gamma R(s_2) + \cdots| \pi].$$</div>
<p><br>
This allows us to derived important equations, <em>Bellman equations</em>,<br>
</p>
<div class="math">$$\begin{equation}
V^\pi(s) = R(s) + \gamma\sum_{s^\prime \in S}P_{s, \pi(s)}(s^\prime)V^\pi(s^\prime).
\label{bellman}
\end{equation}$$</div>
<p>Bellman equations actually give us a system of linear equations which we can use to solve for <span class="math">\(V^\pi(s)\)</span>. I am going to implement in python to get <span class="math">\(V^\pi\)</span>.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="n">py</span> <span class="o">=</span> <span class="s1">&#39;Python &#39;</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Jupyter notebook with kernel: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>

<span class="c1"># states and actions</span>
<span class="n">S</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> 
     <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
<span class="n">A</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)}</span>

<span class="c1"># reward function</span>
<span class="n">R</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.02</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">}</span>
<span class="n">R</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">R</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

<span class="c1"># transition distributions</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">helper</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">[(</span><span class="n">A</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mf">0.8</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="s1">&#39;UD&#39;</span><span class="p">:</span>
        <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">A</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">))</span>
        <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">A</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">A</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">))</span>
        <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">A</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">h</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">yield</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]:</span>
        <span class="k">continue</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">helper</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
            <span class="n">P</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x</span>


<span class="c1"># discount factor</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.99</span>
</pre></div>


<pre>Jupyter notebook with kernel: Python 3.6.4
</pre>

<div class="highlight"><pre><span></span><span class="c1"># policy pi</span>
<span class="n">pi</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span>
      <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span>
      <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="s1">&#39;U&#39;</span><span class="p">}</span>

<span class="c1"># calculate value function for pi</span>
<span class="c1"># with tolerent error</span>
<span class="k">def</span> <span class="nf">val_fn</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)):</span>
    <span class="n">V</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">}</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">nV</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
            <span class="n">nV</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">pi</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">n</span><span class="p">]</span><span class="o">*</span><span class="n">V</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">S</span><span class="p">)</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">-</span><span class="n">nV</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">nV</span>
        <span class="k">if</span> <span class="n">epsilon</span> <span class="o">&lt;</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">V</span>

<span class="n">V</span> <span class="o">=</span> <span class="n">val_fn</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">V</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
</pre></div>


<pre>(0, 0): 0.52
(0, 1): 0.73
(0, 2): 0.77
(0, 3): 1.00
(1, 0): -0.90
(1, 2): -0.82
(1, 3): -1.00
(2, 0): -0.88
(2, 1): -0.87
(2, 2): -0.85
(2, 3): -1.00
</pre>

<p>Therefore, we get the value function <span class="math">\(V^\pi\)</span> for the policy <span class="math">\(\pi\)</span>:<br>
<img alt="value function" src="/images/20180207-example-3.png"></p>
<p>The policy <span class="math">\(\pi\)</span> is far from optimal. In order to find the optimal policy, we need two more definitions.</p>
<div class="qbar">
<p><strong>Definitions.</strong> The <em>optimal value function</em> <span class="math">\(V^\ast\)</span> is defined by<br>
<div class="math">$$V^\ast(s) = \max_{\pi} V^\pi(s),$$</div>
<br>
and the <em>optimal policy</em> <span class="math">\(\pi^\ast\)</span> id defined by<br>
<div class="math">$$\pi^\ast(s) = (\mathrm{argmax}_{\pi} V^\pi(s))(s).$$</div>
</p>
</div>
<p>The optimal value function <span class="math">\(V^\ast\)</span> satisfies also Bellman equations<br>
</p>
<div class="math">$$\begin{equation}
V^\ast(s) = R(s) + \gamma\max_{a \in A} \sum_{s^\prime \in S}P_{s, a}(s^\prime)V^\ast(s^\prime).
\label{bellman-ast}
\end{equation}$$</div>
<p><br>
Moreover, <span class="math">\(\pi^\ast\)</span> can be related to <span class="math">\(V^\ast\)</span> by<br>
</p>
<div class="math">$$\begin{equation}
\pi^\ast(s) = \mathrm{argmax}_{a \in A} \sum_{s^\prime \in S}P_{s, a}(s^\prime)V^\ast(s^\prime).
\label{pi-ast}
\end{equation}$$</div>
<p><br>
These two equations provide two ways to find the optimal policy, <em>value iteration</em> and <em>policy iteration</em>.</p>
<h3>Value Iteration</h3>
<p>The idea of value iteration is to use the Bellman equations <span class="math">\(\eqref{bellman-ast}\)</span> repeatly to determine <span class="math">\(V^\ast\)</span>, then use <span class="math">\(\eqref{pi-ast}\)</span> to find <span class="math">\(\pi^\ast\)</span>.</p>
<div class="highlight"><pre><span></span><span class="c1"># initialize optimal value function</span>
<span class="n">V</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">}</span>

<span class="c1"># tolerent error</span>
<span class="n">error</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">nV</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
        <span class="n">nV</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span><span class="o">*</span><span class="n">V</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">S</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">-</span><span class="n">nV</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">nV</span>
    <span class="k">if</span> <span class="n">epsilon</span> <span class="o">&lt;</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">break</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">V</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
</pre></div>


<pre>(0, 0): 0.86
(0, 1): 0.90
(0, 2): 0.93
(0, 3): 1.00
(1, 0): 0.82
(1, 2): 0.69
(1, 3): -1.00
(2, 0): 0.78
(2, 1): 0.75
(2, 2): 0.71
(2, 3): 0.49
</pre>

<p>From the above piece of code, we get <span class="math">\(V^\ast\)</span>:<br>
<img alt="optimal value function" src="/images/20180207-example-4.png"></p>
<p>Once we have <span class="math">\(V^\ast\)</span>, we can calculate <span class="math">\(\pi^\ast\)</span> easily.</p>
<div class="highlight"><pre><span></span><span class="c1"># optimal policy</span>
<span class="n">pi</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span><span class="o">*</span><span class="n">V</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">S</span><span class="p">))</span>
     <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">}</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]:</span>
        <span class="k">continue</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pi</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
</pre></div>


<pre>(0, 0): R
(0, 1): R
(0, 2): R
(1, 0): U
(1, 2): U
(2, 0): U
(2, 1): L
(2, 2): L
(2, 3): L
</pre>

<p>Therefore, <span class="math">\(\pi^\ast\)</span> is<br>
<img alt="opimal policy" src="/images/20180207-example-5.png"></p>
<h3>Policy iteration</h3>
<p>Policy iteration makes use of equations <span class="math">\(\eqref{pi-ast}\)</span> and <span class="math">\(\eqref{bellman}\)</span>. The algorithm goes in this way.</p>
<pre>initialize pi randomly
repeat {
  1. calculate value function V for pi
  2. update pi using equation (3)
}
</pre>

<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>

<span class="c1"># initialize pi randomly</span>
<span class="n">pi</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">}</span>

<span class="c1"># repeat until stablize</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">val_fn</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">npi</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span><span class="o">*</span><span class="n">V</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">S</span><span class="p">))</span>
          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">pi</span> <span class="o">==</span> <span class="n">npi</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">npi</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]:</span>
        <span class="k">continue</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pi</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
</pre></div>


<pre>(0, 0): R
(0, 1): R
(0, 2): R
(1, 0): U
(1, 2): U
(2, 0): U
(2, 1): L
(2, 2): L
(2, 3): L
</pre>

        <div class="tags">
        <a href="/tag/mdp">MDP</a>
        <a href="/tag/note">note</a>
        </div>


<div id="disqus_thread">
  <div class="btn_click_load">
    <button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button>
  </div>
  <script>
    var disqus_shortname = 'wormtooth';
    var disqus_identifier = '20180207-markov-decision-process/';
    var disqus_title = 'Markov Decision Process';
    var disqus_url = 'https://wormtooth.com/20180207-markov-decision-process/';
    $('.btn_click_load').click(function() {
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || 
          document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      $('.btn_click_load').css('display','none');
    });

    $.ajax({
      url: 'https://disqus.com/favicon.ico',
      timeout: 3000,
      type: 'GET',
      success: (function() {
        var dsq = document.createElement('script'); 
        dsq.type = 'text/javascript'; 
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || 
          document.getElementsByTagName('body')[0]).appendChild(dsq);
        $('.btn_click_load').css('display','none');
      })(),
      error: function() {
        $('.btn_click_load').css('display','block');
        }
      });
  </script>
  <script id="dsq-count-scr" src="//wormtooth.disqus.com/count.js" async></script>
</div>
    </div>
</div>
        </div></div>
        <div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar">
<div class="widget">
    <form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form">
        <input type="text" name="q" maxlength="20" placeholder="Search"/>
        <input type="hidden" name="sitesearch" value="https://wormtooth.com"/>
    </form>
</div><div class="widget">
    <div class="widget-title"><i class="fa fa-heart-o"> 年轻的心只有一面</i></div>
    <img src="/images/mobius_heart.png" class="nofancybox" />
</div><div class="widget">
    <div class="widget-title"><i class="fa fa-paper-plane-o"> 心情随笔</i></div>
    <p>未来会来～</p>
    <span class="qed"><a href="/scribble">View All</a></span>
</div><div class="widget">
    <div class="widget-title">
        <i class="fa fa-folder-o"> Categories</i>
    </div>
    <ul class="category-list">
        <li class="category-list-item"><a class="category-list-link" href="/category/life/">Life</a></li>
        <li class="category-list-item"><a class="category-list-link" href="/category/machine-learning/">Machine Learning</a></li>
        <li class="category-list-item"><a class="category-list-link" href="/category/mathematics/">Mathematics</a></li>
        <li class="category-list-item"><a class="category-list-link" href="/category/notes/">Notes</a></li>
        <li class="category-list-item"><a class="category-list-link" href="/category/programming/">Programming</a></li>
    </ul>
</div><div class="widget">
    <div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div>
    <ul></ul>
    <a href="https://yongjiasong.com/" title="JOY DOMAIN" target="_blank">JOY DOMAIN</a>
</div>
<div class="widget">
    <div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div>
    <script type="text/javascript" src="//wormtooth.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=1&avatar_size=32&excerpt_length=20&hide_mods=1"></script>
</div>
        </div></div>
        <div class="pure-u-1 pure-u-lg-3-4">
<div id="footer">Copyright © 2022 <a href="/." rel="nofollow">叶某人的碎碎念.</a> <a rel="nofollow" target="_blank" href="https://getpelican.com/">Pelican</a> &amp; <a rel="nofollow", target="_blank", href="https://github.com/wormtooth/maupassant-pelican">maupassant</a>.</div>        </div>
    </div>
</div>
<a id="rocket" href="#top" class="show"></a>
<script type="text/javascript" src="/theme/js/totop.js" async></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.js" async></script>
<script type="text/javascript" src="/theme/js/fancybox.js" async></script>
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.css" />

<script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$', '$$'], ["\\[", "\\]"] ],
      processEscapes: true
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      },
      Macros: {
        N: "\\mathbb{N}",
        Z: "\\mathbb{Z}",
        Q: "\\mathbb{Q}",
        R: "\\mathbb{R}",
        C: "\\mathbb{C}"
      }
    },
    'HTML-CSS': {
      imageFont: null
    }
  });
</script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.1.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>