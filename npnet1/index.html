<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style" />
    <meta content="telephone=no" name="format-detection" />
    <title>
[npnet] 线性回归 | 叶某人的碎碎念    </title>
    <link rel="stylesheet" type="text/css" href="/theme/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/theme/css/pygment.css" />
    <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css" />
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css" />
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css" />
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico" />
</head>

<body>
<div class="body_container">
    <div id="header">
        <div class="site-name">
            <a id="logo" href="/."> 叶某人的碎碎念 </a>
            <p class="description"> Believe in Mathematics </p>
        </div>
        <div id="nav-menu">
            <a href="/."><i class="fa fa-home"> Home</i></a>
            <a href="/movies/"><i class="fa fa-film"> Movies</i></a>
            <a href="/archives.html"><i class="fa fa-archive"> Archive</i></a>
        </div>
    </div>
    <div id="layout" class="pure-g">
        <div class="pure-u-1 pure-u-lg-3-4"><div class="content_container">
<div class="post">
    <h1 class="post-title">[npnet] 线性回归</h1>
    <div class="post-meta">Oct 05, 2019
    <span> | </span> <span>Machine Learning</span>
    </div>
    <a data-disqus-identifier="npnet1/" href="/npnet1/#disqus_thread" class="disqus-comment-count"></a>
    <div class="post-content">
        <p>我们现在已经知道机器学习三个重要的模块是<strong>模型 (model)</strong>、<strong>标准 (criterion)</strong> 以及 <strong>优化 (optimization)</strong>。在这篇笔记中我们讨论各个模块必要的基本功能，然后用 Python 给出模块的基类 (base class)。 最后我们继承这些基类实现上一篇笔记的线性模型 (linear model) 以及均方误差 (mean square error)。</p>
<!--more-->

<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="o">%</span><span class="n">run</span> <span class="n">import_npnet</span><span class="o">.</span><span class="n">py</span>
<span class="n">npnet</span> <span class="o">=</span> <span class="n">import_npnet</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<h1>模型</h1>
<p>一个模型抽象来看是一个函数 <span class="math">\(f(x; a)\)</span>，其中 <span class="math">\(a\)</span> 是模型的参数。因此一个模型必须要保存参数其自身的参数，以及实现函数 <span class="math">\(f(x; a)\)</span> 的功能 （也叫正向传播/前馈 (<a href="https://en.wikipedia.org/wiki/Feedforward_neural_network">feedforward</a>)）。另外，我们还需要损失函数对参数的偏导数来进行梯度下降，所以我们还需要在模型中实现反向传播 (<a href="https://en.wikipedia.org/wiki/Backpropagation">backpropagation</a>) 并保存计算好的偏导数。</p>
<div class="highlight"><pre><span></span><span class="c1"># import</span>
<span class="k">class</span> <span class="nc">Model</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_init_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">params</span><span class="p">,</span> <span class="n">grads</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gradients</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">grads</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;&lt;{self.__class__.__name__}&gt;&quot;</span>
</pre></div>


<p><code>Model</code> 中定义了两个属性 (property) <code>Model._parameters</code> 和 <code>Model._gradients</code>。这两个属性返回对应属性的列表 (list) 形式。比如 <code>Model._parameters</code> 检查 <code>Model.parameters</code> 是否为列表，若是则直接返回，若不是则返回只有其一个元素的列表。这两个属性是为了方便以后的实现。我们还定义了 <code>Model._init_gradients</code>。当我们定义好 <code>Model.parameters</code> 之后，我们可以用这个方法初始化所有偏导数为0。</p>
<h2>线性回归</h2>
<p>线性回归模型的数学表达式是<br>
</p>
<div class="math">$$y = x W + b,$$</div>
<p><br>
其中 <span class="math">\(x\)</span> 是长度为 <span class="math">\(m\)</span> 的行向量 (row vector)，<span class="math">\(y\)</span> 是长度为 <span class="math">\(n\)</span> 的行向量，<span class="math">\(W\)</span> 是 <span class="math">\(m \times n\)</span> 的矩阵 (matrix)，<span class="math">\(b\)</span> 是长度为 <span class="math">\(n\)</span> 的行向量，最后 <span class="math">\(x W\)</span> 是矩阵乘法，<span class="math">\(+\)</span> 是向量加法。在这个模型中，<span class="math">\(W\)</span> 和 <span class="math">\(b\)</span> 是模型参数。在 <code>numpy</code> 中，我们使用 <code>@</code> 代表矩阵乘法。知道这点，我们很容易写出 <code>Linear.forward</code> 的代码。难点在于如何正确地用 <code>numpy</code> 计算参数 <code>W</code> 和 <code>b</code> 对于损失函数的偏导数。</p>
<p>在实际应用中，<span class="math">\(x\)</span> 并只是一个行向量，而是由若干个行向量形成的矩阵。假设 <span class="math">\(x\)</span> 是一个 <span class="math">\(l \times m\)</span> 矩阵。这说的是 <span class="math">\(x\)</span> 是由 <span class="math">\(l\)</span> 个长度为 <span class="math">\(m\)</span> 的行向量构成的。因为 <code>numpy</code> 的广播 (broadcasting) 机制，我们可以将这样一个 <span class="math">\(l \times m\)</span> 矩阵 <span class="math">\(x\)</span> 作为输入，得到一个 <span class="math">\(l \times n\)</span> 的矩阵 <span class="math">\(y\)</span>。<span class="math">\(y\)</span> 每一行是 <span class="math">\(x\)</span> 相对应的那行代入上述线性公式得到的。这样我们相当于可以同时计算多个输入。这是便利，也为我们的反向传播的实现增加了难度。</p>
<p>假设观测值也组成一个 <span class="math">\(l \times n\)</span> 矩阵 <span class="math">\(\tilde{y}\)</span>。我们记 <span class="math">\(x = (x_{ij}), y = (y_{ij}), W = (W_{ij}), b = (b_1, \dots, b_n)\)</span>. 展开 <span class="math">\(y = xW + b\)</span> 我们得到<br>
</p>
<div class="math">$$y_{ij} = \sum_{k=1}^m x_{ik} W_{kj} + b_j.$$</div>
<p><br>
根据反向传播的过程，我们会有一个 <span class="math">\(l \times n\)</span> 矩阵 <span class="math">\(g = (g_{ij})\)</span> 作为后面传递回来的梯度。这个传递回来的梯度的矩阵大小是跟我们模型的矩阵大小是一致的。假设最终的损失是 <span class="math">\(L\)</span>。那么对于每个 <span class="math">\(b_h\)</span>，我们有<br>
</p>
<div class="math">$$\frac{\partial L}{\partial b_h} = \sum_{i, j} \frac{\partial L}{\partial y_{ij}} \cdot \frac{\partial y_{ij}}{\partial b_h} = \sum_{ij} g_{i,j}\delta_{jh} = \sum_{i=1}^l g_{ih}.$$</div>
<p> <br>
这里 <span class="math">\(\delta_{ij} = 1\)</span> 当且仅当 <span class="math">\(i = j\)</span>，否则等于0。同样地，我们对每个 <span class="math">\(W_{uv}\)</span>,<br>
</p>
<div class="math">$$\frac{\partial L}{\partial W_{uv}} = \sum_{i, j} \frac{\partial L}{\partial y_{ij}} \cdot \frac{\partial y_{ij}}{W_{uv}} = \sum_{i, j} g_{ij} x_{iu} \delta_{jv} = \sum_{i=1}^l g_{iv}x_{iu}.$$</div>
<p>通过上面的计算，我们发现对于 <span class="math">\(b\)</span> 的偏导数我们可以将 <span class="math">\(g\)</span> 的每一行加起来得到，而对于 <span class="math">\(W\)</span> 的偏导数，我们可以简单地用矩阵乘法 <span class="math">\(\frac{\partial L}{\partial W} = x^T g\)</span> 来表示。其中 <span class="math">\(x^T\)</span> 是 <span class="math">\(x\)</span> 的转置矩阵。至此我们已经成功推出参数的偏导数公式。但是我们还需要求出对于输入 <span class="math">\(x\)</span> 的偏导数，作为梯度传递到前面去以继续反向传播的过程。对每个 <span class="math">\(x_{uv}\)</span>，<br>
</p>
<div class="math">$$\frac{\partial L}{\partial x_{uv}} = \sum_{i, j} \frac{\partial L}{\partial y_{ij}} \cdot \frac{\partial y_{ij}}{\partial x_{uv}} = \sum_{i, j} g_{ij}W_{vj}\delta_{iu} = \sum_{j=1}^n g_{uj}W_{vj}.$$</div>
<p><br>
也就是说需要反向传播回去的梯度是 <span class="math">\(\frac{\partial L}{\partial x} = g W^T\)</span>。</p>
<p>根据上面的推导公式，我们可以得到一下线性模型的实现。值得注意的是参数 <span class="math">\(W\)</span> 的初始化，我使用的是 He initialization 。选择这样的初始化是因为后面我们常用的是 <a href="https://en.wikipedia.org/wiki/Rectifier_(neural_networks)">ReLU</a> 激活函数。在使用 ReLU 时，这样的初始化有助于模型更快地收敛。</p>
<div class="highlight"><pre><span></span><span class="c1"># import</span>
<span class="k">class</span> <span class="nc">Linear</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">in_features</span><span class="p">,</span>
                         <span class="n">out_features</span><span class="o">=</span><span class="n">out_features</span><span class="p">)</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">n</span><span class="p">))</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_gradients</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span> <span class="err">@</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">T</span> <span class="err">@</span> <span class="n">grad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grad</span> <span class="err">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</pre></div>


<h1>标准</h1>
<div class="highlight"><pre><span></span><span class="c1"># import</span>
<span class="k">class</span> <span class="nc">Criterion</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;&lt;{self.__class__.__name__}&gt;&quot;</span>
</pre></div>


<h2>均方误差</h2>
<p>假设 <span class="math">\(y\)</span> 是预测值，<span class="math">\(\tilde{y}\)</span> 是观测值。均方误差的数学公式是<br>
</p>
<div class="math">$$L(y, \tilde{y}) = \frac{1}{2} |y - \tilde{y}|_2^2.$$</div>
<p><br>
这里的 <span class="math">\(|x|_2^2\)</span> 是求 <span class="math">\(x\)</span> 的 L2 范式 (L2 norm) 的平方，是平方函数的向量推广。如果 <span class="math">\(x = (x_1, \dots, x_n)\)</span>， 那么<br>
</p>
<div class="math">$$|x|_2^2 = \sum_{i=1}^n x_i^2.$$</div>
<p>我们需要计算 <span class="math">\(\frac{\partial L}{\partial y}\)</span>：<br>
</p>
<div class="math">$$\frac{\partial L}{\partial y} = y - \tilde{y}.$$</div>
<div class="highlight"><pre><span></span><span class="c1"># import</span>
<span class="k">class</span> <span class="nc">MSELoss</span><span class="p">(</span><span class="n">Criterion</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">output</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">/</span> <span class="n">n</span>
</pre></div>


<p>我们发现 <code>MSELoss.forward</code> 和 <code>MSELoss.backward</code> 都除以了 <code>n = output.shape[0]</code>。这是因为 <code>targt</code> 是将所有观测到的 <code>y</code> 放在一起形成的矩阵。<code>target</code> 的每一行代表一个观测点的 <code>y</code> 值。同理，<code>output</code> 的每一行代表对一个观测点的预测。按照之前我们的讨论，总的误差是所有观测点误差的平均值，所以要除以观测点的个数。</p>
<h1>优化器</h1>
<p>我们在后面的笔记中实现类似 <a href="https://pytorch.org/docs/stable/nn.html#sequential"><code>torch.nn.Sequential</code></a> 的简单神经网络。其本质就是将一些简单的模型串起来形成一个更大更深的模型。考虑到这种串型网络，我们将一个基本模型看作包含一个基本模型的串型网络。优化器 (Optimizer) 要将所有模型的参数以及它们的偏导数放在各自的列表来获取统一处理的便利。</p>
<div class="highlight"><pre><span></span><span class="c1"># import</span>
<span class="k">class</span> <span class="nc">Optimizer</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_gradients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">zero_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">grads</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grads</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">g</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;&lt;{self.__class__.__name__}&gt;&quot;</span>
</pre></div>


<h2>随机梯度下降</h2>
<p>我们之前说的梯度下降是使用所有的观测点来计算各个参数的偏导数，才进行一次参数更新。而随机梯度下降 (<a href="https://en.wikipedia.org/wiki/Stochastic_gradient_descent">stochastic gradient descent</a>) 是每次使用一个观测点去进行梯度下降法，也就是只使用一个观测点来计算各个参数的偏导数。随机梯度下降每次计算的梯度必然没有梯度下降计算的梯度准确，但是它使用了更小的内存，而且被证明能达到梯度下降的效果。</p>
<p>在我们的实现中，优化与梯度的计算是分开的，所以随机梯度下降与梯度下降在实现中并没有区别。我选择了 <code>SGD</code> 这个更常见的名字来命名这个实现。</p>
<div class="highlight"><pre><span></span><span class="c1"># import</span>
<span class="k">class</span> <span class="nc">SGD</span><span class="p">(</span><span class="n">Optimizer</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span>
        <span class="k">for</span> <span class="n">params</span><span class="p">,</span> <span class="n">grads</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">grads</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</pre></div>


<h1>导数验证</h1>
<p>每当我们实现一个模型时，我们最担心的就是能否正确地计算偏导数。所以我们需要用数值方法计算导数来验证 <code>Model.backward</code> 的正确性。给定一个函数 <span class="math">\(f(x)\)</span>，我们可以通过以下公式估算 <span class="math">\(f^\prime(x)\)</span>：<br>
</p>
<div class="math">$$\frac{f(x+h) - f(x-h)}{2h}.$$</div>
<p><br>
这个想法能推广到多元函数。</p>
<div class="highlight"><pre><span></span><span class="c1"># import</span>
<span class="k">class</span> <span class="nc">GradientCheck</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">sample</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">allowed_error</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="k">if</span> <span class="nb">input</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_error</span> <span class="o">=</span> <span class="n">allowed_error</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">MSELoss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">check_gradient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_gradient</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_parameters</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_gradients</span>
        <span class="k">for</span> <span class="n">params</span><span class="p">,</span> <span class="n">grads</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">gradients</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_gradient</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">grads</span><span class="p">[</span><span class="n">name</span><span class="p">]):</span>
                    <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">check_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">grad</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">shape</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span>
        <span class="n">criterion</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">allowed_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_error</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
            <span class="n">point</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">)</span>
            <span class="n">comp</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">+=</span> <span class="n">h</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">high</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">comp</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">h</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">low</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">comp</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">+=</span> <span class="n">h</span>
            <span class="n">numerical_grad_at_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
            <span class="n">analytic_grad_at_point</span> <span class="o">=</span> <span class="n">grad</span><span class="p">[</span><span class="n">point</span><span class="p">]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">numerical_grad_at_point</span> <span class="o">-</span> <span class="n">analytic_grad_at_point</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="n">allowed_error</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 每次调用 self.model.forward 之前都会先调用此方法</span>
        <span class="k">pass</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">linear</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">GradientCheck</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>


<pre>True</pre>

<h1>直线拟合</h1>
<p>在上一篇笔记里我们已经用两种方法做过了简单的直线拟合。我们现在使用 <code>Linear</code> 、<code>MSELoss</code> 和 <code>SGD</code> 来重新做一遍直线拟合。首先我们先生成数据。</p>
<div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<p><img src="data:image/png;base64,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
"/></p>
<p>因为我们将机器学习的三个重要组成部分模块化了，所以使用起来也非常方便以及统一。我将这个过程用注释标记在下面的代码例子中。</p>
<div class="highlight"><pre><span></span><span class="c1">#建立模型</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># 记录下当前模型的初始值供后面的使用</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># 选定超参数 (hyperparameter)</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># 选择标准以及优化器</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">MSELoss</span><span class="p">()</span>
<span class="n">optim</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>

<span class="c1"># 训练模型</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># 预测</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">y</span><span class="p">)</span> <span class="c1"># 计算损失</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># 得到反向传播的初始梯度</span>
    <span class="n">optim</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span> <span class="c1"># 清除之前的偏导数</span>
    <span class="n">model</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span> <span class="c1"># 通过反向传播计算参数的偏导数</span>
    <span class="n">optim</span><span class="o">.</span><span class="n">step</span><span class="p">()</span> <span class="c1"># 使用优化器更新参数</span>

<span class="c1"># 检测模型</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;truth&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<p><img src="data:image/png;base64,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
"/></p>
<p>最后，我们重新用上一遍笔记的梯度下降法计算 <span class="math">\(y = ax + b\)</span> 的参数 <span class="math">\(a\)</span> 和 <span class="math">\(b\)</span>。我们使用跟 <code>model</code> 一样的参数初值，通过同样100次迭代得到了跟 <code>model.parameters</code> 一样的参数，这从另一个侧面验证我们的实现是正确的。</p>
<div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sxy</span><span class="p">,</span> <span class="n">sx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">ga</span> <span class="o">=</span> <span class="p">(</span><span class="n">sx2</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">b</span> <span class="o">-</span> <span class="n">sxy</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">gb</span> <span class="o">=</span> <span class="p">(</span><span class="n">sx</span> <span class="o">*</span> <span class="n">a</span> <span class="o">-</span> <span class="n">sy</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> <span class="o">+</span> <span class="n">b</span>
    <span class="n">a</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">ga</span>
    <span class="n">b</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">gb</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;a: {a:.8f}, b: {b:.8f}&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
</pre></div>


<pre>a: 3.18370140, b: -0.86291890
{'W': array([[3.1837014]]), 'b': array([-0.8629189])}
</pre>

        <div class="tags">
        <a href="/tag/python">python</a>
        <a href="/tag/numpy">numpy</a>
        <a href="/tag/npnet">npnet</a>
        </div>


<div id="disqus_thread">
  <div class="btn_click_load">
    <button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button>
  </div>
  <script>
    var disqus_shortname = 'wormtooth';
    var disqus_identifier = 'npnet1/';
    var disqus_title = '[npnet] 线性回归';
    var disqus_url = 'https://wormtooth.com/npnet1/';
    $('.btn_click_load').click(function() {
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || 
          document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      $('.btn_click_load').css('display','none');
    });

    $.ajax({
      url: 'https://disqus.com/favicon.ico',
      timeout: 3000,
      type: 'GET',
      success: (function() {
        var dsq = document.createElement('script'); 
        dsq.type = 'text/javascript'; 
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || 
          document.getElementsByTagName('body')[0]).appendChild(dsq);
        $('.btn_click_load').css('display','none');
      })(),
      error: function() {
        $('.btn_click_load').css('display','block');
        }
      });
  </script>
  <script id="dsq-count-scr" src="//wormtooth.disqus.com/count.js" async></script>
</div>
    </div>
</div>
        </div></div>
        <div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar">
<div class="widget">
    <form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form">
        <input type="text" name="q" maxlength="20" placeholder="Search"/>
        <input type="hidden" name="sitesearch" value="https://wormtooth.com"/>
    </form>
</div><div class="widget">
    <div class="widget-title"><i class="fa fa-heart-o"> 年轻的心只有一面</i></div>
    <img src="/images/mobius_heart.png" class="nofancybox" />
</div><div class="widget">
    <div class="widget-title"><i class="fa fa-paper-plane-o"> 心情随笔</i></div>
    <p>含蓄的极致是闷骚，闷骚的极致是深情。</p>
    <span class="qed"><a href="/scribble">View All</a></span>
</div><div class="widget">
    <div class="widget-title">
        <i class="fa fa-folder-o"> Categories</i>
    </div>
    <ul class="category-list">
        <li class="category-list-item"><a class="category-list-link" href="/category/life/">Life</a></li>
        <li class="category-list-item"><a class="category-list-link" href="/category/machine-learning/">Machine Learning</a></li>
        <li class="category-list-item"><a class="category-list-link" href="/category/mathematics/">Mathematics</a></li>
        <li class="category-list-item"><a class="category-list-link" href="/category/notes/">Notes</a></li>
        <li class="category-list-item"><a class="category-list-link" href="/category/programming/">Programming</a></li>
    </ul>
</div><div class="widget">
    <div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div>
    <ul></ul>
    <a href="https://yongjiasong.com/" title="JOY DOMAIN" target="_blank">JOY DOMAIN</a>
</div>
<div class="widget">
    <div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div>
    <script type="text/javascript" src="//wormtooth.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=1&avatar_size=32&excerpt_length=20&hide_mods=1"></script>
</div>
        </div></div>
        <div class="pure-u-1 pure-u-lg-3-4">
<div id="footer">Copyright © 2019 <a href="/." rel="nofollow">叶某人的碎碎念.</a> <a rel="nofollow" target="_blank" href="https://getpelican.com/">Pelican</a> &amp; <a rel="nofollow", target="_blank", href="https://github.com/wormtooth/maupassant-pelican">maupassant</a>.</div>        </div>
    </div>
</div>
<a id="rocket" href="#top" class="show"></a>
<script type="text/javascript" src="/theme/js/totop.js" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script>
<script type="text/javascript" src="/theme/js/fancybox.js" async></script>
<link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css" />

<script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$', '$$'], ["\\[", "\\]"] ],
      processEscapes: true
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      },
      Macros: {
        N: "\\mathbb{N}",
        Z: "\\mathbb{Z}",
        Q: "\\mathbb{Q}",
        R: "\\mathbb{R}",
        C: "\\mathbb{C}"
      }
    },
    'HTML-CSS': {
      imageFont: null
    }
  });
</script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.1.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>